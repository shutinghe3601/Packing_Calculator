<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Packing Optimization</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        .input-container {
            text-align: center;
            padding: 20px;
            background-color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        .input-container input {
            display: block;
            margin: 10px auto;
            padding: 8px;
            width: 80%;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .input-container button {
            margin-top: 10px;
            padding: 10px 20px;
            border: none;
            background-color: #4CAF50;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        .input-container button:hover {
            background-color: #45a049;
        }
        .output-container {
            margin-top: 20px;
            text-align: center;
        }
        table {
            margin: 0 auto;
            border-collapse: collapse;
            width: 80%;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
    <script type="text/javascript" src="../data/locData.js"></script>
    <script type="text/javascript" src="../data/caseData.js"></script>
    <!-- <script type="text/javascript" src="./create3DPlot.js"></script> -->
    <script type="text/javascript" src="./computation.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/110/three.min.js"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/troika-three-text/dist/troika-three-text.umd.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

</head>
<body>
    <div class="input-container">
     
        <style>
            .aligned-input {
                display: block;
                margin: 10px auto;
                padding: 8px;
                width: 80%;
                border: 1px solid #ccc;
                border-radius: 4px;
            }
        </style>

        <label for="warehouseNumber">Select Warehouse Number</label>
        <div style="margin-bottom: 10px;"></div> <!-- Adds a 15px space gap -->
        <select id="warehouseNumber" class="aligned-input">
            <option value="101">101</option>
        </select>

        <div style="margin-bottom: 15px;"></div> <!-- Adds a 15px space gap -->

        <label for="locationNumber">Select Location Number</label>
        <div style="margin-bottom: 10px;"></div> <!-- Adds a 15px space gap -->
        <select id="locationNumber" class="aligned-input">
            <option value="B03">B03</option>
            <option value="B07">B07</option>
            <option value="B08">B08</option>
            <option value="B18">B18</option>
            <option value="B20">B20</option>
        </select>
        <div style="margin-bottom: 15px;"></div> <!-- Adds a 15px space gap -->

        <label for="skuId">Select SKU ID</label>
        <div style="margin-bottom: 10px;"></div> <!-- Adds a 15px space gap -->
        <select id="skuId" class="aligned-input">
            <option value="14">14</option>
            <option value="22">22</option>
            <option value="23">23</option>
            <option value="37">37</option>
            <option value="60">60</option>
        </select>

        <button onclick="handleSubmit()">Submit</button>

        <div class="output-container" id="outputContainer"></div>
    </div>
    <script>
        async function handleSubmit() {
            const warehouseNumber = document.getElementById('warehouseNumber').value;
            const locationNumber = document.getElementById('locationNumber').value;
            const skuId = document.getElementById('skuId').value;

            try {
                const computation_result = comprehensive(
                    warehouseNumber,
                    locationNumber,
                    skuId);
                // const result = optimizeCasePacking(
                //     warehouseNumber,
                //     locationNumber,
                //     skuId,
                //     locData,
                //     caseData
                // );

                const {optCases, optSolution, occupiedW, occupiedL, occupiedW2, occupiedL2, dims, complication, newCaseDims} = computation_result;

                const outputContainer = document.getElementById('outputContainer');
                // const { totalCases, packingOrientations } = result;
                // const loc = locData.find(
                //     (l) => l.warehouse_number.toString() === warehouseNumber && l.location_number.toString() === locationNumber
                // );
                const item = caseData.find((i) => i.sku_id.toString() === skuId);

                // const locDims = [loc.width_inch, loc.depth_inch, loc.height_inch];
                // const caseDims = [item.case_width, item.case_length, item.case_height];
                const skuName = item.name;

                console.log("Computation Result:", computation_result);
                console.log("optSolution.orient:", computation_result.optSolution.orient);

                if (newCaseDims.every(dim => dim === 0)) {
                    outputContainer.innerHTML = `
                        <h3>Packing Solution</h3>
                        <p><strong>SKU Name:</strong> ${skuName}</p>
                        <p><strong>Location Dimensions:</strong> ${dims.join(' x ')}</p>
                        <p><strong>Case Dimensions:</strong> ${newCaseDims.join(' x ')}</p>
                        <p style="color: red;">This SKU has invalid dimension data in the system. Please remeasure for accurate results.</p>
                    `;
                    return;
                }

                // Transform optSolution as per Python logic
                Object.keys(optSolution).forEach(key => {
                    const value = optSolution[key];
                    if (Array.isArray(value) && value[1] && value[1][1]) {
                        optSolution[key] = [value[0], value[1][0], value[1][1]];
                    } else if (Array.isArray(value) && value[1] && value[1][0]) {
                        optSolution[key] = [value[0], value[1][0]];
                    } else {
                        optSolution[key] = value[0];
                    }
                });

                // Generate table rows
                let rows = optSolution.orient.flatMap((orient, index) => {
                    if (orient === null) return [];
                    if (Array.isArray(orient)) {
                        return `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${orient.join(' x ')}</td>
                                <td>${optSolution.n_case[index ] || 0}</td>
                            </tr>
                        `;
                    }
                    return `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${orient.join(' x ')}</td>
                            <td>${optSolution.n_case[index ] || 0}</td>
                        `;
                }).join('');

                console.log("optSolution.orient:", optSolution.orient);

                outputContainer.innerHTML = `
                    <h3>Packing Solution</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Orientation</th>
                                <th>Number of Cases</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                    <p><strong>SKU Name:</strong> ${skuName}</p>
                    <p><strong>Total Cases:</strong> ${optCases}</p>
                    <p><strong>Location Dimensions:</strong> ${dims.join(' x ')}</p>
                    <p><strong>Case Dimensions:</strong> ${newCaseDims.join(' x ')}</p>
                `;
                // Add 3D Plot
                const plotContainer = document.createElement('div');
                plotContainer.id = 'plotContainer';
                outputContainer.appendChild(plotContainer);

                create3DPlot(computation_result); // insert file2 here 
                // createLegend()
            } catch (error) {
                const outputContainer = document.getElementById('outputContainer');
                outputContainer.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }

        }

        function create3DPlot(computation_result) {
            const plotContainer = document.getElementById('plotContainer');

            const locDims = computation_result.dims;
            const occupiedW = computation_result.occupiedW;
            const occupiedL = computation_result.occupiedL;
            const occupiedW2 = computation_result.occupiedW2;
            const occupiedL2 = computation_result.occupiedL2;
            const complication = computation_result.complication; 
            const optSolution = computation_result.optSolution;

            // Clear any previous canvas
            while (plotContainer.firstChild) {
                plotContainer.removeChild(plotContainer.firstChild);
            }

            // Create scene, camera, and renderer
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0xf5f5dc); // Beige background
            plotContainer.appendChild(renderer.domElement);

            // Add cubic 3D space (bounding box)
            const [locWidth, locDepth, locHeight] = locDims;
            const spaceGeometry = new THREE.BoxGeometry(locWidth, locHeight, locDepth);
            const spaceMaterial = new THREE.MeshBasicMaterial({
                color: 0x87ceeb, // Light blue
                wireframe: true,
                transparent: true,
                opacity: 0.5,
            });
            const spaceMesh = new THREE.Mesh(spaceGeometry, spaceMaterial);
            spaceMesh.position.set(locWidth / 2, locHeight / 2, locDepth / 2);
            scene.add(spaceMesh);

            // Function to add a box to the scene
            function addBox(x, y, z, w, h, d, color, opacity = 0.7) {
                const geometry = new THREE.BoxGeometry(w, h, d);
                const material = new THREE.MeshBasicMaterial({ color, transparent: true, opacity });
                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(x + w / 2, z + h / 2, y + d / 2);

                // Add edges for better visibility
                const edges = new THREE.EdgesGeometry(geometry);
                const edgeMaterial = new THREE.LineBasicMaterial({ color: 0x000000 });
                const edgeLines = new THREE.LineSegments(edges, edgeMaterial);
                mesh.add(edgeLines);

                scene.add(mesh);
            }

            // Add existing SKU block (unstackable)
            addBox(0, 0, 0, occupiedW, locHeight, occupiedL, 0xff0000,0.7); // Red box

            // Add main orientation block
            const [w1, l1, h1] = optSolution.orient[0];
            if (complication) {
                addBox(0, occupiedL + occupiedL2, 0, w1, h1, l1, 0x00ff00); // Green box attached to the stack
            } else {
                addBox(0, occupiedL, 0, w1, h1, l1, 0x00ff00); // Green box
            }

            // Add sub-orientation block if present
            if (optSolution.orient[1][0] != null) {
                const [w2, l2, h2] = optSolution.orient[1][0];

                if (optSolution.orient[1] != [null] && complication) {
                    addBox(occupiedW2, occupiedL2, 0, w2, h2, l2, 0x0000ff); // Blue box
                } else if (optSolution.orient[1] != [null] ) { // && optSolution.orient[1].length === 1
                    addBox(occupiedW, 0, 0, w2, h2, l2, 0x0000ff); // Blue box attached to the first row
                }
            }

            // Add complication block if needed
            if (complication) {
                addBox(0, occupiedL, 0, occupiedW2, locHeight, occupiedL2, 0xff0000, 0.7); // Additional red block

                if (optSolution.orient[1].length > 1 && optSolution.orient[1][1] != null) {
                    const [w3, l3, h3] = optSolution.orient[1][1];
                    addBox(occupiedW, 0, 0, w3, h3, l3, 0xffc0cb); // Another blue block
                }
            }

            // Add 'Front' label
            const loader = new THREE.FontLoader();
            loader.load('https://threejs.org/examples/fonts/droid/droid_sans_regular.typeface.json', function (font) {
                const textGeometry = new THREE.TextGeometry('Width (Front)', {
                    font: font,
                    size: locHeight * 0.1, // Scale size relative to bounding box
                    height: 0.5,
                });
                const textMaterial = new THREE.MeshBasicMaterial({ color: 0x7a7a7a }); // Grey color
                const textMesh = new THREE.Mesh(textGeometry, textMaterial);

                // Position the text at the front-center of the box
                textMesh.position.set(locWidth / 3, 0, locDepth + locHeight * 0.3); 
                textMesh.rotation.x = -Math.PI / 2; // Rotate 90 degrees clockwise along the X-axis

                scene.add(textMesh);
            }); 

            // Position and angle the camera
            camera.position.set(locWidth * 1.5, locHeight * 2.5, locDepth * 1.5);
            camera.lookAt(locWidth / 2, locHeight / 2, locDepth / 2);

            // Animation loop to render the scene
            function animate() {
                requestAnimationFrame(animate);
                renderer.render(scene, camera);
            }
            animate();
        }

        // Function to create the legend dynamically
        function createLegend() {
        const legendContainer = document.createElement('div');
        legendContainer.className = 'legend-container';

        // Define legend items
        const legendItems = [
            { color: 'red', text: 'Location Inventory Blocks' },
            { color: 'green', text: 'Main Orientation' },
            { color: 'blue', text: 'Sub-Orientation 1' },
            { color: 'pink', text: 'Sub-Orientation 2' },
        ];

        // Generate legend rows
        legendItems.forEach(item => {
            const legendRow = document.createElement('div');
            legendRow.className = 'legend-row';

            const legendBox = document.createElement('div');
            legendBox.className = 'legend-box';
            legendBox.style.backgroundColor = item.color;

            const legendText = document.createElement('span');
            legendText.className = 'legend-text';
            legendText.textContent = item.text;

            legendRow.appendChild(legendBox);
            legendRow.appendChild(legendText);
            legendContainer.appendChild(legendRow);
        });

        // Add the legend container to the body
        document.body.appendChild(legendContainer);
        }
    </script>
</body>
</html>
