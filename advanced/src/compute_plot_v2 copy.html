<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Packing Optimization</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        .input-container {
            text-align: center;
            padding: 20px;
            background-color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        .input-container input {
            display: block;
            margin: 10px auto;
            padding: 8px;
            width: 80%;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .input-container button {
            margin-top: 10px;
            padding: 10px 20px;
            border: none;
            background-color: #4CAF50;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        .input-container button:hover {
            background-color: #45a049;
        }
        .output-container {
            margin-top: 20px;
            text-align: center;
        }
        table {
            margin: 0 auto;
            border-collapse: collapse;
            width: 80%;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
    <script type="text/javascript" src="../data/locData.js"></script>
    <script type="text/javascript" src="../data/caseData.js"></script>
    <!-- <script type="text/javascript" src="./create3DPlot.js"></script> -->
    <script type="text/javascript" src="./computation.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/110/three.min.js"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/troika-three-text/dist/troika-three-text.umd.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

</head>
<body>
    <div class="input-container">
     
        <style>
            .aligned-input {
                display: block;
                margin: 10px auto;
                padding: 8px;
                width: 80%;
                border: 1px solid #ccc;
                border-radius: 4px;
            }
        </style>

        <label for="warehouseNumber">Select Warehouse Number</label>
        <div style="margin-bottom: 10px;"></div> <!-- Adds a 15px space gap -->
        <select id="warehouseNumber" class="aligned-input">
            <option value="101">101</option>
        </select>

        <div style="margin-bottom: 15px;"></div> <!-- Adds a 15px space gap -->

        <label for="locationNumber">Select Location Number</label>
        <div style="margin-bottom: 10px;"></div> <!-- Adds a 15px space gap -->
        <select id="locationNumber" class="aligned-input">
            <option value="B03">B03</option>
            <option value="B07">B07</option>
            <option value="B08">B08</option>
            <option value="B18">B18</option>
            <option value="B20">B20</option>
        </select>
        <div style="margin-bottom: 15px;"></div> <!-- Adds a 15px space gap -->

        <label for="skuId">Select SKU ID</label>
        <div style="margin-bottom: 10px;"></div> <!-- Adds a 15px space gap -->
        <select id="skuId" class="aligned-input">
            <option value="14">14</option>
            <option value="22">22</option>
            <option value="23">23</option>
            <option value="37">37</option>
            <option value="60">60</option>
        </select>

        <button onclick="handleSubmit()">Submit</button>

        <div class="output-container" id="outputContainer"></div>
    </div>
    <script>
        async function handleSubmit() {
            const warehouseNumber = document.getElementById('warehouseNumber').value;
            const locationNumber = document.getElementById('locationNumber').value;
            const skuId = document.getElementById('skuId').value;

            try {
                const computation_result = comprehensive(
                    warehouseNumber,
                    locationNumber,
                    skuId);
                // const result = optimizeCasePacking(
                //     warehouseNumber,
                //     locationNumber,
                //     skuId,
                //     locData,
                //     caseData
                // );

                const {optCases, optSolution, occupiedW, occupiedL, occupiedW2, occupiedL2, dims, complication, newCaseDims} = computation_result;

                const outputContainer = document.getElementById('outputContainer');
                // const { totalCases, packingOrientations } = result;
                // const loc = locData.find(
                //     (l) => l.warehouse_number.toString() === warehouseNumber && l.location_number.toString() === locationNumber
                // );
                const item = caseData.find((i) => i.sku_id.toString() === skuId);

                // const locDims = [loc.width_inch, loc.depth_inch, loc.height_inch];
                // const caseDims = [item.case_width, item.case_length, item.case_height];
                const skuName = item.name;

                console.log("Computation Result:", computation_result);
                console.log("optSolution.orient:", computation_result.optSolution.orient);

                if (newCaseDims.every(dim => dim === 0)) {
                    outputContainer.innerHTML = `
                        <h3>Packing Solution</h3>
                        <p><strong>SKU Name:</strong> ${skuName}</p>
                        <p><strong>Location Dimensions:</strong> ${dims.join(' x ')}</p>
                        <p><strong>Case Dimensions:</strong> ${newCaseDims.join(' x ')}</p>
                        <p style="color: red;">This SKU has invalid dimension data in the system. Please remeasure for accurate results.</p>
                    `;
                    return;
                }

                // Transform optSolution as per Python logic
                Object.keys(optSolution).forEach(key => {
                    const value = optSolution[key];
                    if (Array.isArray(value) && value[1] && value[1][1]) {
                        optSolution[key] = [value[0], value[1][0], value[1][1]];
                    } else if (Array.isArray(value) && value[1] && value[1][0]) {
                        optSolution[key] = [value[0], value[1][0]];
                    } else {
                        optSolution[key] = value[0];
                    }
                });

                // Generate table rows
                let rows = optSolution.orient.flatMap((orient, index) => {
                    if (orient === null) return [];
                    if (Array.isArray(orient)) {
                        return `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${orient.join(' x ')}</td>
                                <td>${optSolution.n_case[index ] || 0}</td>
                            </tr>
                        `;
                    }
                    return `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${orient.join(' x ')}</td>
                            <td>${optSolution.n_case[index ] || 0}</td>
                        `;
                }).join('');

                console.log("optSolution.orient:", optSolution.orient);

                outputContainer.innerHTML = `
                    <h3>Packing Solution</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Orientation</th>
                                <th>Number of Cases</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                    <p><strong>SKU Name:</strong> ${skuName}</p>
                    <p><strong>Total Cases:</strong> ${optCases}</p>
                    <p><strong>Location Dimensions:</strong> ${dims.join(' x ')}</p>
                    <p><strong>Case Dimensions:</strong> ${newCaseDims.join(' x ')}</p>
                `;
                // Add 3D Plot
                const plotContainer = document.createElement('div');
                plotContainer.id = 'plotContainer';
                outputContainer.appendChild(plotContainer);

                create3DPlot(computation_result); // insert file2 here 
                // createLegend()
            } catch (error) {
                const outputContainer = document.getElementById('outputContainer');
                outputContainer.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }

        }

        function create3DPlot(computation_result) {
    const plotContainer = document.getElementById('plotContainer');

    if (!plotContainer) {
        console.error('Plot container not found.');
        return;
    }

    // Clear any previous canvas
    while (plotContainer.firstChild) {
        plotContainer.removeChild(plotContainer.firstChild);
    }

    const { dims, occupiedW, occupiedL, occupiedW2, occupiedL2, complication, optSolution } = computation_result;

    if (!Array.isArray(optSolution.orient) || optSolution.orient.length === 0) {
        console.error('optSolution.orient is not valid.');
        plotContainer.innerHTML = '<p style="color: red;">Error: Invalid orientation data.</p>';
        return;
    }

    // Scene, camera, and renderer setup
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, plotContainer.offsetWidth / 400, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(plotContainer.offsetWidth, 400);
    renderer.setClearColor(0xf5f5dc); // Beige background
    plotContainer.appendChild(renderer.domElement);

    // Adding bounding box
    const [locWidth, locDepth, locHeight] = dims;
    const spaceGeometry = new THREE.BoxGeometry(locWidth, locHeight, locDepth);
    const spaceMaterial = new THREE.MeshBasicMaterial({
        color: 0x87ceeb, wireframe: true, transparent: true, opacity: 0.5,
    });
    const spaceMesh = new THREE.Mesh(spaceGeometry, spaceMaterial);
    scene.add(spaceMesh);

    // Function to add a box
    function addBox(x, y, z, w, h, d, color, opacity = 0.7) {
        const geometry = new THREE.BoxGeometry(w, h, d);
        const material = new THREE.MeshBasicMaterial({ color, transparent: true, opacity });
        const mesh = new THREE.Mesh(geometry, material);
        mesh.position.set(x + w / 2, z + h / 2, y + d / 2);
        scene.add(mesh);
    }

    // Add blocks based on orientations
    optSolution.orient.forEach((orientation, index) => {
        if (Array.isArray(orientation)) {
            const [w, l, h] = orientation;
            const color = [0x00ff00, 0x0000ff, 0xffc0cb][index] || 0x999999; // Green, Blue, Pink
            addBox(index * w, occupiedL + index * l, 0, w, h, l, color);
        }
    });

    // Positioning the camera
    camera.position.set(locWidth * 1.5, locHeight * 2, locDepth * 1.5);
    camera.lookAt(locWidth / 2, locHeight / 2, locDepth / 2);

    // Animation loop
    function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
    }
    animate();
}

// Add the legend
function createLegend(outputContainer) {
    const legendContainer = document.createElement('div');
    legendContainer.style.textAlign = 'center';
    legendContainer.style.marginTop = '10px';

    const legendItems = [
        { color: 'green', text: 'Main Orientation' },
        { color: 'blue', text: 'Sub-Orientation' },
        { color: 'pink', text: 'Additional Blocks' },
    ];

    legendItems.forEach(item => {
        const legendItem = document.createElement('div');
        legendItem.style.display = 'inline-block';
        legendItem.style.margin = '0 10px';

        const colorBox = document.createElement('span');
        colorBox.style.display = 'inline-block';
        colorBox.style.width = '15px';
        colorBox.style.height = '15px';
        colorBox.style.backgroundColor = item.color;
        colorBox.style.marginRight = '5px';

        legendItem.appendChild(colorBox);
        legendItem.appendChild(document.createTextNode(item.text));
        legendContainer.appendChild(legendItem);
    });

    outputContainer.appendChild(legendContainer);
}

// Invoke the functions in handleSubmit
const outputContainer = document.getElementById('outputContainer');
create3DPlot(computation_result);
createLegend(outputContainer);

    </script>
</body>
</html>
